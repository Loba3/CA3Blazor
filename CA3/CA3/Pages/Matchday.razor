@page "/matchday"
@using CA3.Models
@using CA3.Services
@inject OpenLigaService Api

<h2>Matchday Viewer</h2>

<div class="d-flex align-items-center gap-2 mb-3">

    <!-- LEAGUE -->
    <select class="form-select w-auto" @bind="selectedLeague">
        <option value="bl1">1. Bundesliga </option>
        <option value="bl2">2. Bundesliga </option>
        <option value="bl3">3. Bundesliga </option>
    </select>

    <!-- YEAR / SEASON -->
    <input type="number" class="form-control w-auto" @bind="selectedSeason" />

    <!-- MATCHDAY -->
    <input type="number" class="form-control w-auto" @bind="selectedMatchday" />

    <button class="btn btn-primary" @onclick="LoadMatches">Load</button>
</div>

@if (loading)
{
    <p>Loading matches...</p>
}
else if (matches == null || matches.Count == 0)
{
    <p>No matches found for this selection.</p>
}
else
{
    <h5>@selectedLeague @selectedSeason – Matchday @selectedMatchday</h5>

    @foreach (var m in matches)
    {
        <div class="card my-3">
            <div class="card-body">

                <!-- Match header -->
                <h5>
                    <img src="@m.Team1?.teamIconUrl" width="25" />
                    @m.Team1?.teamName
                    <span class="mx-1">vs</span>
                    <img src="@m.Team2?.teamIconUrl" width="25" />
                    @m.Team2?.teamName
                </h5>

                <!-- Score or kickoff -->
                @if (m.matchIsFinished)
                {
                    var result = m.matchResults?.FirstOrDefault(r => r.resultTypeID == 2);
                    if (result != null)
                    {
                        <p class="fw-bold">
                            @result.pointsTeam1 – @result.pointsTeam2
                        </p>
                    }
                    else
                    {
                        <p>Finished</p>
                    }
                }
                else
                {
                    <p>@m.matchDateTime.ToString("dd MMM HH:mm")</p>
                }

                <!-- Goals list -->
                @if (m.goals != null && m.goals.Any())
                {
                    <ul class="mb-0">
                        @foreach (var g in m.goals)
                        {
                            <li>
                                <b>@g.goalGetterName</b>
                                (@g.matchMinute') – @g.scoreTeam1:@g.scoreTeam2
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted mb-0">No goals recorded.</p>
                }

            </div>
        </div>
    }
}

@code {
    private string selectedLeague = "bl1";
    private int selectedSeason = DateTime.Now.Year;
    private int selectedMatchday = 1;

    private bool loading = false;
    private List<MatchData>? matches;

    private async Task LoadMatches()
    {
        loading = true;

        matches = await Api.GetMatchdayAsync(
            selectedLeague,
            selectedSeason,
            selectedMatchday);

        loading = false;
    }
}
